<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Service Container class
 *
 * @copyright Copyright (C) 1999-2012 eZ Systems AS. All rights reserved.
 * @license http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
 * @version //autogentag//
 */

namespace eZ\Publish\Core\Base;
use eZ\Publish\Core\Base\ConfigurationManager,
    eZ\Publish\Core\Base\Exception\BadConfiguration,
    eZ\Publish\Core\Base\Exception\InvalidArgumentValue,
    eZ\Publish\Core\Base\Exception\MissingClass,
    ReflectionClass;

/**
 * Service container class
 *
 * A dependency injection container that uses configuration for defining dependencies.
 *
 * Usage:
 *
 *     $sc = new eZ\Publish\Core\Base\ServiceContainer( Configuration::getInstance('service')-&gt;getAll() );
 *     $sc-&gt;getRepository-&gt;getContentService()...;
 *
 * Or overriding $dependencies (in unit tests):
 * ( $dependencies keys should have same value as service.ini &quot;arguments&quot; values explained bellow )
 *
 *     $sc = new eZ\Publish\Core\Base\ServiceContainer(
 *         Configuration::getInstance('service')-&gt;getAll(),
 *         array(
 *             '@persistence_handler' =&gt; new \eZ\Publish\Core\Persistence\InMemory\Handler()
 *         )
 *     );
 *     $sc-&gt;getRepository-&gt;getContentService()...;
 *
 * Settings are defined in service.ini like the following example:
 *
 *     [repository]
 *     shared=true
 *     class=eZ\Publish\Core\Base\Repository
 *     arguments[persistence_handler]=@inmemory_persistence_handler
 *
 *     [inmemory_persistence_handler]
 *     shared=true
 *     class=eZ\Publish\Core\Persistence\InMemory\Handler
 *
 *     @todo Update service.ini reference bellow
 *     # @see \eZ\Publish\Core\Base\settings\service.ini For more options and examples.
 *
 * &quot;arguments&quot; values in service.ini can start with either @ in case of other services being dependency, $ if a
 * predefined global variable is to be used ( currently: $_SERVER, $_REQUEST, $_COOKIE, $_FILES and $serviceContainer )
 * or plain scalar if that is to be given directly as argument value.
 */
class ServiceContainer
{
    /**
     * Holds service objects and variables
     *
     * @var object[]
     */
    private $dependencies;

    /**
     * Array of optional settings overrides
     *
     * @var array[]
     */
    private $settings;

    /**
     * Construct object with optional configuration overrides
     *
     * @param array $settings Services settings
     * @param mixed[]|object[] $dependencies Optional initial dependencies
     */
    public function __construct( array $settings, array $dependencies = array() )
    {
        $this-&gt;settings = $settings;
        $this-&gt;dependencies = $dependencies + array(
            '$_SERVER' =&gt; $_SERVER,
            '$_REQUEST' =&gt; $_REQUEST,
            '$_COOKIE' =&gt; $_COOKIE,
            '$_FILES' =&gt; $_FILES,
        );
    }

    /**
     * Service function to get ConfigurationManager object
     *
     * Alias with type hints for $repo-&gt;get( 'configuration' );
     *
     * @uses get()
     * @return \eZ\Publish\Core\Base\ConfigurationManager
     */
    public function getConfigurationManager()
    {
        if ( isset( $this-&gt;dependencies['@configuration'] ) )
            return $this-&gt;dependencies['@configuration'];
        // will not work as ConfigurationManager has dependencies on config.php settings at least
        return $this-&gt;get( 'configuration' );
    }

    /**
     * Service function to get Repository object
     *
     * Alias with type hints for $repo-&gt;get( 'repository' );
     *
     * @uses get()
     * @return \eZ\Publish\API\Repository\Repository
     */
    public function getRepository()
    {
        if ( isset( $this-&gt;dependencies['@repository'] ) )
            return $this-&gt;dependencies['@repository'];
        return $this-&gt;get( 'repository' );
    }

    /**
     * Get service by name
     *
     * @uses lookupArguments()
     * @throws BadConfiguration
     * @throws MissingClass
     * @param string $serviceName
     * @return object
     */
    public function get( $serviceName )
    {
        $serviceKey = &quot;@{$serviceName}&quot;;

        // Return directly if it already exists
        if ( isset( $this-&gt;dependencies[$serviceKey] ) )
        {
            return $this-&gt;dependencies[$serviceKey];
        }

        // Validate settings
        if ( empty( $this-&gt;settings[$serviceName] ) )
        {
            throw new BadConfiguration( &quot;service\\[{$serviceName}]&quot;, &quot;no settings exist for '{$serviceName}'&quot; );
        }

        $settings = $this-&gt;settings[$serviceName] + array( 'shared' =&gt; false );
        if ( empty( $settings['class'] ) )
        {
            throw new BadConfiguration( &quot;service\\[{$serviceName}]\\class&quot;, 'class setting is not defined' );
        }

        if ( !class_exists( $settings['class'] ) )
        {
            throw new MissingClass( $settings['class'], 'service' );
        }

        // Create service directly if it does not have any arguments
        if ( empty( $settings['arguments'] ) )
        {
            if ( $settings['shared'] )
                return $this-&gt;dependencies[$serviceKey] = new $settings['class']();

            return new $settings['class']();
        }

        // Expand arguments with other service objects on arguments that start with @ and predefined variables that start with $
        $argumentKeys = array();
        $arguments = $this-&gt;lookupArguments( $settings['arguments'], $argumentKeys );

        // Use &quot;new&quot; if just 1 or 2 arguments (premature optimization to avoid use of reflection in most cases)
        if ( isset( $argumentKeys[0] ) &amp;&amp; !isset( $argumentKeys[2] ) )
        {
            if ( !isset( $argumentKeys[1] ) )
                $serviceObject = new $settings['class']( $arguments[ $argumentKeys[0] ] );
            else
                $serviceObject = new $settings['class']( $arguments[ $argumentKeys[0] ], $arguments[ $argumentKeys[1] ] );
        }
        else // use Reflection to create a new instance, using the $args
        {
            $reflectionObj = new ReflectionClass( $settings['class'] );
            $serviceObject =  $reflectionObj-&gt;newInstanceArgs( $arguments );
        }

        if ( $settings['shared'] )
            $this-&gt;dependencies[$serviceKey] = $serviceObject;

        return $serviceObject;
    }

    /**
     * Lookup arguments for variable, service or arrays for recursive lookup
     *
     * @throws InvalidArgumentValue
     * @param array $arguments
     * @param array &amp;$keys Optional, keys in array will be appended in the order they are found (but not recursively)
     * @return array
     */
    protected function lookupArguments( array $arguments, array &amp;$keys = array() )
    {
        $builtArguments = array();
        foreach ( $arguments as $key =&gt; $argument )
        {
            if ( isset( $argument[0] ) &amp;&amp; ( $argument[0] === '$' || $argument[0] === '@' ) )
            {
                if ( $argument === '$serviceContainer' )
                {
                    // Self
                    $builtArguments[$key] = $this;
                }
                else if ( isset( $this-&gt;dependencies[ $argument ] ) )
                {
                    // Existing dependencies (@Service / $Variable)
                    $builtArguments[$key] = $this-&gt;dependencies[ $argument ];
                }
                else if ( $argument[0] === '$' )
                {
                    // Undefined variables will trow an exception
                    throw new InvalidArgumentValue( &quot;arguments[{$key}]&quot;, $argument );
                }
                else
                {
                    // Try to load a @service dependency
                    $builtArguments[$key] = $this-&gt;get( ltrim( $argument, '@' ) );
                }
            }
            else if ( is_array( $argument ) )
            {
                $builtArguments[$key] = $this-&gt;lookupArguments( $argument );
            }
            else // Scalar values
            {
                $builtArguments[$key] = $argument;
            }
            $keys[] = $key;
        }
        return $builtArguments;
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>