<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * File containing the Handler interface
 *
 * @copyright Copyright (C) 1999-2012 eZ Systems AS. All rights reserved.
 * @license http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
 * @version //autogentag//
 */

namespace eZ\Publish\Core\Persistence\Legacy;
use eZ\Publish\SPI\Persistence\Handler as HandlerInterface,
    eZ\Publish\Core\Persistence\Legacy\Content,
    eZ\Publish\Core\Persistence\Legacy\Content\Type,
    eZ\Publish\Core\Persistence\Legacy\Content\Handler as ContentHandler,
    eZ\Publish\Core\Persistence\Legacy\Content\FieldHandler as ContentFieldHandler,
    eZ\Publish\Core\Persistence\Legacy\Content\Type\Handler as TypeHandler,
    eZ\Publish\Core\Persistence\Legacy\Content\Type\Mapper as TypeMapper,
    eZ\Publish\Core\Persistence\Legacy\Content\Language\Mapper as LanguageMapper,
    eZ\Publish\Core\Persistence\Legacy\Content\Location\Handler as LocationHandler,
    eZ\Publish\Core\Persistence\Legacy\Content\Location\Mapper as LocationMapper,
    eZ\Publish\Core\Persistence\Legacy\Content\Mapper as ContentMapper,
    eZ\Publish\Core\Persistence\Legacy\Content\StorageRegistry,
    eZ\Publish\Core\Persistence\Legacy\Content\StorageHandler,
    eZ\Publish\Core\Persistence\Legacy\Content\Search\TransformationProcessor,
    eZ\Publish\Core\Persistence\Legacy\Content\Search\TransformationParser,
    eZ\Publish\Core\Persistence\Legacy\Content\Search\TransformationPcreCompiler,
    eZ\Publish\Core\Persistence\Legacy\Content\Search\Utf8Converter,
    eZ\Publish\Core\Persistence\Legacy\Content\Search\Gateway\CriterionHandler,
    eZ\Publish\Core\Persistence\Legacy\Content\Search\Gateway\SortClauseHandler,
    eZ\Publish\Core\Persistence\Legacy\EzcDbHandler\Pgsql,
    eZ\Publish\Core\Persistence\Legacy\EzcDbHandler\Sqlite,
    eZ\Publish\Core\Persistence\Legacy\User,
    eZ\Publish\Core\Persistence\Legacy\User\Mapper as UserMapper,
    ezcDbFactory;

/**
 * The repository handler for the legacy storage engine
 *
 * @todo If possible, the handler should not receive the DSN but the database
 *       connection instead, so that the implementation becomes fully testable.
 */
class Handler implements HandlerInterface
{
    /**
     * Content handler
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Handler
     */
    protected $contentHandler;

    /**
     * Content mapper
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Mapper
     */
    protected $contentMapper;

    /**
     * Field value converter registry
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\FieldValue\Converter\Registry
     */
    protected $fieldValueConverterRegistry;

    /**
     * Storage registry
     *
     * @var Content\StorageRegistry
     */
    protected $storageRegistry;

    /**
     * Storage registry
     *
     * @var Content\StorageHandler
     */
    protected $storageHandler;

    /**
     * Field handler
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\FieldHandler
     */
    protected $fieldHandler;

    /**
     * Search handler
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Search\Handler
     */
    protected $searchHandler;

    /**
     * Content type handler
     *
     * @var Content\Type\Handler
     */
    protected $contentTypeHandler;

    /**
     * Content Type gateway
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Type\Gateway
     */
    protected $contentTypeGateway;

    /**
     * Content Type update handler
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Type\Update\Handler
     */
    protected $typeUpdateHandler;

    /**
     * Location handler
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Location\Handler
     */
    protected $locationHandler;

    /**
     * Location gateway
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Location\Gateway
     */
    protected $locationGateway;

    /**
     * Location mapper
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Location\Mapper
     */
    protected $locationMapper;

    /**
     * User handler
     *
     * @var User\Handler
     */
    protected $userHandler;

    /**
     * Section handler
     *
     * @var mixed
     */
    protected $sectionHandler;

    /**
     * Content gateway
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Gateway
     */
    protected $contentGateway;

    /**
     * Language handler
     *
     * @var \eZ\Publish\SPI\Persistence\Content\Language\Handler
     */
    protected $languageHandler;

    /**
     * Language cache
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Language\Cache
     */
    protected $languageCache;

    /**
     * Language mask generator
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Content\Language\MaskGenerator
     */
    protected $languageMaskGenerator;

    /**
     * Configurator
     *
     * @var \eZ\Publish\Core\Persistence\Legacy\Configurator
     */
    protected $configurator;

    /**
     * Creates a new repository handler.
     *
     * The $config parameter expects an array of configuration values as
     * follows:
     *
     * &lt;code&gt;
     * array(
     *  'dsn' =&gt;'&lt;database_type&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;/&lt;database_name&gt;',
     *  'defer_type_update' =&gt; &lt;true|false&gt;,
     *  'external_storages' =&gt; array(
     *      '&lt;type_name1&gt;' =&gt; '&lt;storage_class_1&gt;',
     *      '&lt;type_name2&gt;' =&gt; '&lt;storage_class_2&gt;',
     *      // ...
     *  ),
     *  'field_converters' =&gt; array(
     *      '&lt;type_name1&gt;' =&gt; '&lt;converter_class_1&gt;',
     *      '&lt;type_name2&gt;' =&gt; '&lt;converter_class_2&gt;',
     *      // ...
     *  ),
     *  'transformation_rule_files' =&gt; array(
     *      '&lt;full_file_path_1&gt;',
     *      '&lt;full_file_path_2&gt;',
     *      // ...
     *  )
     * )
     * &lt;/code&gt;
     *
     * The DSN (data source name) defines which database to use. It's format is
     * defined by the Apache Zeta Components Database component. Examples are:
     *
     * - mysql://root:secret@localhost/ezp
     *   for the MySQL database &quot;ezp&quot; on localhost, which will be accessed
     *   using user &quot;root&quot; with password &quot;secret&quot;
     * - sqlite://:memory:
     *   for a SQLite in memory database (used e.g. for unit tests)
     *
     * For further information on the database setup, please refer to
     * {@see http://incubator.apache.org/zetacomponents/documentation/trunk/Database/tutorial.html#handler-usage}
     *
     * The flag 'defer_type_update' defines if content types should be
     * published immediatly (false), when the
     * {@link \eZ\Publish\SPI\Persistence\Content\Type\Handler::publish()} method is
     * called, or if a background process should be triggered (true), which is
     * then executed by the old eZ Publish core.
     *
     * In 'external_storages' a mapping of field type names to classes is
     * expected. The referred class is instantiated and the resulting object is
     * used to store/restore/delete/&acirc;€&brvbar; data in external storages (e.g. another
     * database or a web service). The classes must comply to the
     * {@link \eZ\Publish\SPI\Persistence\Fields\Storage} interface. Note that due to the
     * configuration mechanism and missing proper DI, the classes may not
     * expect any constructor parameters!
     *
     * The 'field_converter' configuration array consists of another mapping of
     * field type names to classes. Each of the classes is instantiated and
     * used to convert content fields and content type field definitions to the
     * legacy storage engine. The given class names must derive the
     * {@link \eZ\Publish\Core\Persistence\Legacy\Content\FieldValue\Converter}
     * class. As for 'external_storage' classes, none of the classes may expect
     * parameters in its constructor, due to missing proper DI.
     *
     * Through the 'transformation_rule_files' array, a list of files with
     * full text transformation rules is given. These files are read by an
     * instance of
     * {@link \eZ\Publish\Core\Persistence\Legacy\Converter\Search\TransformationProcessor}
     * and then used for normalization in the full text search.
     *
     * @param array $config
     */
    public function __construct( array $config )
    {
        $this-&gt;configurator = new Configurator( $config );
    }

    /**
     * Returns the Zeta Database handler
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\EzcDbHandler
     */
    protected function getDatabase()
    {
        if ( !isset( $this-&gt;dbHandler ) )
        {
            $connection = ezcDbFactory::create( $this-&gt;configurator-&gt;getDsn() );
            $database = preg_replace( '(^([a-z]+).*)', '\\1', $this-&gt;configurator-&gt;getDsn() );

            switch ( $database )
            {
                case 'pgsql':
                    $this-&gt;dbHandler = new Pgsql( $connection );
                    break;

                case 'sqlite':
                    $this-&gt;dbHandler = new Sqlite( $connection );
                    break;

                default:
                    $this-&gt;dbHandler = new EzcDbHandler( $connection );
            }
        }
        return $this-&gt;dbHandler;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Handler
     */
    public function contentHandler()
    {
        if ( !isset( $this-&gt;contentHandler ) )
        {
            $this-&gt;contentHandler = new ContentHandler(
                $this-&gt;getContentGateway(),
                $this-&gt;getLocationGateway(),
                $this-&gt;getContentMapper(),
                $this-&gt;getFieldHandler()
            );
        }
        return $this-&gt;contentHandler;
    }

    /**
     * Returns a content mapper
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Mapper
     */
    protected function getContentMapper()
    {
        if ( !isset( $this-&gt;contentMapper ) )
        {
            $this-&gt;contentMapper = new ContentMapper(
                $this-&gt;getLocationMapper(),
                $this-&gt;getFieldValueConverterRegistry()
            );
        }
        return $this-&gt;contentMapper;
    }

    /**
     * Returns a content gateway
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Gateway
     */
    protected function getContentGateway()
    {
        if ( !isset( $this-&gt;contentGateway ) )
        {
            $this-&gt;contentGateway = new Content\Gateway\EzcDatabase(
                $this-&gt;getDatabase(),
                new Content\Gateway\EzcDatabase\QueryBuilder( $this-&gt;getDatabase() ),
                $this-&gt;contentLanguageHandler(),
                $this-&gt;getLanguageMaskGenerator()
            );
        }
        return $this-&gt;contentGateway;
    }

    /**
     * Returns a field handler
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\FieldHandler
     */
    protected function getFieldHandler()
    {
        if ( !isset( $this-&gt;fieldHandler ) )
        {
            $this-&gt;fieldHandler = new ContentFieldHandler(
                $this-&gt;getContentGateway(),
                $this-&gt;getContentTypeGateway(),
                $this-&gt;getContentMapper(),
                $this-&gt;getStorageHandler()
            );
        }
        return $this-&gt;fieldHandler;
    }

    /**
     * Returns a language mask generator
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Language\MaskGenerator
     */
    protected function getLanguageMaskGenerator()
    {
        if ( !isset( $this-&gt;languageMaskGenerator ) )
        {
            $this-&gt;languageMaskGenerator = new Content\Language\MaskGenerator(
                $this-&gt;contentLanguageHandler()
            );
        }
        return $this-&gt;languageMaskGenerator;
    }

    /**
     * Returns the field value converter registry
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\FieldValue\Converter\Registry
     */
    public function getFieldValueConverterRegistry()
    {
        if ( !isset( $this-&gt;fieldValueConverterRegistry ) )
        {
            $this-&gt;fieldValueConverterRegistry =
                new Content\FieldValue\Converter\Registry();
            $this-&gt;configurator-&gt;configureFieldConverter(
                $this-&gt;fieldValueConverterRegistry
            );
        }
        return $this-&gt;fieldValueConverterRegistry;
    }

    /**
     * Returns the storage registry
     *
     * @return Content\StorageRegistry
     */
    public function getStorageRegistry()
    {
        if ( !isset( $this-&gt;storageRegistry ) )
        {
            $this-&gt;storageRegistry = new StorageRegistry();
            $this-&gt;configurator-&gt;configureExternalStorages(
                $this-&gt;storageRegistry
            );
        }
        return $this-&gt;storageRegistry;
    }

    /**
     * Returns a storage handler
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\StorageHandler
     */
    protected function getStorageHandler()
    {
        if ( !isset( $this-&gt;storageHandler ) )
        {
            $this-&gt;storageHandler = new StorageHandler(
                $this-&gt;getStorageRegistry(),
                $this-&gt;getContentGateway()-&gt;getContext()
            );
        }
        return $this-&gt;storageHandler;
    }

    /**
     * Get a transformation processor for full text search normalization
     *
     * @return TransformationProcessor
     */
    protected function getTransformationProcessor()
    {
        $processor = new TransformationProcessor(
            new TransformationParser(),
            new TransformationPcreCompiler(
                new Utf8Converter()
            )
        );

        // @TODO: How do we get the path to the currently used transformation
        // files?
        $path = '.';
        foreach ( glob( $path . '/*.tr' ) as $file )
        {
            $processor-&gt;loadRules( $file );
        }

        return $processor;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Search\Handler
     */
    public function searchHandler()
    {
        if ( !isset( $this-&gt;searchHandler ) )
        {
            $db = $this-&gt;getDatabase();
            $this-&gt;searchHandler = new Content\Search\Handler(
                new Content\Search\Gateway\EzcDatabase(
                    $db,
                    new Content\Search\Gateway\CriteriaConverter(
                        array(
                            new CriterionHandler\ContentId( $db ),
                            new CriterionHandler\LogicalNot( $db ),
                            new CriterionHandler\LogicalAnd( $db ),
                            new CriterionHandler\LogicalOr( $db ),
                            new CriterionHandler\Subtree( $db ),
                            new CriterionHandler\ContentTypeId( $db ),
                            new CriterionHandler\ContentTypeGroupId( $db ),
                            new CriterionHandler\DateMetadata( $db ),
                            new CriterionHandler\LocationId( $db ),
                            new CriterionHandler\ParentLocationId( $db ),
                            new CriterionHandler\RemoteId( $db ),
                            new CriterionHandler\SectionId( $db ),
                            new CriterionHandler\Status( $db ),
                            new CriterionHandler\FullText(
                                $db,
                                $this-&gt;getTransformationProcessor()
                            ),
                            new CriterionHandler\Field(
                                $db,
                                $this-&gt;getFieldValueConverterRegistry()
                            ),
                        )
                    ),
                    new Content\Search\Gateway\SortClauseConverter(
                        array(
                            new SortClauseHandler\LocationPathString( $db ),
                            new SortClauseHandler\LocationDepth( $db ),
                            new SortClauseHandler\LocationPriority( $db ),
                        )
                    ),
                    new Content\Gateway\EzcDatabase\QueryBuilder( $this-&gt;getDatabase() )
                ),
                $this-&gt;getContentMapper(),
                $this-&gt;getFieldHandler()
            );
        }
        return $this-&gt;searchHandler;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Type\Handler
     */
    public function contentTypeHandler()
    {
        if ( !isset( $this-&gt;contentTypeHandler ) )
        {
            $this-&gt;contentTypeHandler = new TypeHandler(
                $this-&gt;getContentTypeGateway(),
                new TypeMapper( $this-&gt;getFieldValueConverterRegistry() ),
                $this-&gt;getTypeUpdateHandler()
            );
        }
        return $this-&gt;contentTypeHandler;
    }

    /**
     * Returns a Content Type update handler
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Type\Update\Handler
     */
    protected function getTypeUpdateHandler()
    {
        if ( !isset( $this-&gt;typeUpdateHandler ) )
        {
            if ( $this-&gt;configurator-&gt;shouldDeferTypeUpdates() )
            {
                $this-&gt;typeUpdateHandler = new Type\Update\Handler\DeferredLegacy(
                    $this-&gt;getContentGateway()
                );
            }
            else
            {
                $this-&gt;typeUpdateHandler = new Type\Update\Handler\EzcDatabase(
                    $this-&gt;getContentTypeGateway(),
                    new Type\ContentUpdater(
                        $this-&gt;searchHandler(),
                        $this-&gt;getContentGateway(),
                        $this-&gt;getFieldValueConverterRegistry()
                    )
                );
            }
        }
        return $this-&gt;typeUpdateHandler;
    }

    /**
     * Returns the content type gateway
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Type\Gateway
     */
    protected function getContentTypeGateway()
    {
        if ( !isset( $this-&gt;contentTypeGateway ) )
        {
            $this-&gt;contentTypeGateway = new Type\Gateway\EzcDatabase(
                $this-&gt;getDatabase(),
                $this-&gt;getLanguageMaskGenerator()
            );
        }
        return $this-&gt;contentTypeGateway;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Language\Handler
     */
    public function contentLanguageHandler()
    {
        if ( !isset( $this-&gt;languageHandler ) )
        {
            $this-&gt;languageHandler = new Content\Language\CachingHandler(
                new Content\Language\Handler(
                    new Content\Language\Gateway\EzcDatabase( $this-&gt;getDatabase() ),
                    new LanguageMapper()
                ),
                $this-&gt;getLanguageCache()
            );
        }
        return $this-&gt;languageHandler;
    }

    /**
     * Returns a Language cache
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Language\Cache
     */
    protected function getLanguageCache()
    {
        if ( !isset( $this-&gt;languageCache ) )
        {
            $this-&gt;languageCache = new Content\Language\Cache();
        }
        return $this-&gt;languageCache;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Location\Handler
     */
    public function locationHandler()
    {
        if ( !isset( $this-&gt;locationHandler ) )
        {
            $this-&gt;locationHandler = new LocationHandler(
                $this-&gt;getLocationGateway(),
                $this-&gt;getLocationMapper(),
                $this-&gt;contentHandler(),
                $this-&gt;getContentMapper()
            );
        }
        return $this-&gt;locationHandler;
    }

    /**
     * Returns a location gateway
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Location\Gateway\EzcDatabase
     */
    protected function getLocationGateway()
    {
        if ( !isset( $this-&gt;locationGateway ) )
        {
            $this-&gt;locationGateway = new Content\Location\Gateway\EzcDatabase( $this-&gt;getDatabase() );
        }
        return $this-&gt;locationGateway;
    }

    /**
     * Returns a location mapper
     *
     * @return \eZ\Publish\Core\Persistence\Legacy\Content\Location\Mapper
     */
    protected function getLocationMapper()
    {
        if ( !isset( $this-&gt;locationMapper ) )
        {
            $this-&gt;locationMapper = new LocationMapper();
        }
        return $this-&gt;locationMapper;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\User\Handler
     */
    public function userHandler()
    {
        if ( !isset( $this-&gt;userHandler ) )
        {
            $this-&gt;userHandler = new User\Handler(
                new User\Gateway\EzcDatabase( $this-&gt;getDatabase() ),
                new User\Role\Gateway\EzcDatabase( $this-&gt;getDatabase() ),
                new UserMapper()
            );
        }
        return $this-&gt;userHandler;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Section\Handler
     */
    public function sectionHandler()
    {
        if ( !isset( $this-&gt;sectionHandler ) )
        {
            $this-&gt;sectionHandler = new Content\Section\Handler(
                new Content\Section\Gateway\EzcDatabase( $this-&gt;getDatabase() )
            );
        }
        return $this-&gt;sectionHandler;
    }

    /**
     * @return \eZ\Publish\SPI\Persistence\Content\Location\Trash\Handler
     */
    public function trashHandler()
    {
        throw new \RuntimeException( 'Not implemented yet' );
    }

    /**
     */
    public function beginTransaction()
    {
        $this-&gt;getDatabase()-&gt;beginTransaction();
    }

    /**
     */
    public function commit()
    {
        $this-&gt;getDatabase()-&gt;commit();
    }

    /**
     */
    public function rollback()
    {
        $this-&gt;getDatabase()-&gt;rollback();
    }
}
?&gt;
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>