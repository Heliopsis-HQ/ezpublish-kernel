<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Repository class
 *
 * @copyright Copyright (C) 1999-2012 eZ Systems AS. All rights reserved.
 * @license http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
 * @version //autogentag//
 */

namespace ezp\Base;
use ezp\Base\Exception\InvalidArgumentValue,
    ezp\Base\Exception\BadConfiguration,
    ezp\Io\BinaryFile,
    ezp\Io\BinaryFileUpdateStruct,
    ezp\Io\BinaryFileCreateStruct,
    ezp\Io\ContentType,
    DateTime;

/**
 * Repository class
 *
 */
class BinaryRepository
{
    /**
     * BinaryStorage backends instances
     * Uninstanciated ones have false as a value
     * @var \ezp\Io\Handler[]
     */
    private $backends = array();

    /**
     * Default BinaryStorage backend identifier
     * @var string
     */
    private $defaultBackend;

    /**
     * Default backend override value
     * @var string
     */
    private static $defaultBackendOverride;

    /**
     * Backends list override value
     * @var array
     */
    private static $backendsOverride;

    /**
     * Bbackends configuration override value
     * @var array
     */
    private static $backendsConfigurationOverride;

    /**
     * Constructs the binary repository, either with the default or with override parameters
     * @param string $defaultBackendOverride Override identifier for the default backend
     * @param array $backendsOverride Override of the backends list
     * @param array $backendsConfigurationOverride
     */
    public function __construct( $defaultBackendOverride = null, $backendsOverride = null, $backendsConfigurationOverride = null )
    {
        if ( $defaultBackendOverride === null &amp;&amp; self::$defaultBackendOverride !== null )
        {
            $defaultBackendOverride = self::$defaultBackendOverride;
        }

        $this-&gt;configuration = Configuration::getInstance( 'io' );

        $backends = $this-&gt;configuration-&gt;get( 'backends', 'Backends' );
        if ( $backendsOverride != null )
        {
            $backends = $backendsOverride + $backends;
        }
        if ( self::$backendsOverride !== null )
        {
            $backends = self::$backendsOverride + $backends;
        }

        // all backends are indexed, identifier as key, false as the value
        $this-&gt;backends = array_fill_keys( array_values( $backends ), false );

        if ( $defaultBackendOverride !== null )
        {
            $this-&gt;defaultBackend = $defaultBackendOverride;
        }
        else
        {
            $this-&gt;defaultBackend = $this-&gt;configuration-&gt;get( 'general', 'DefaultBinaryFileBackend' );
        }

        if ( self::$backendsConfigurationOverride !== null )
        {
            if ( $backendsConfigurationOverride !== null )
            {
                $backendsConfigurationOverride = $backendsConfigurationOverride + self::$backendsConfigurationOverride;
            }
            else
            {
                $backendsConfigurationOverride = self::$backendsConfigurationOverride;
            }
        }
        $this-&gt;initBackend( $this-&gt;defaultBackend, $backendsConfigurationOverride );
    }

    /**
     * Sets global override options for the BinaryRepository
     * @param string $defaultBackendOverride Override identifier for the default backend
     * @param array $backendsOverride Override of the backends list
     * @param array $backendsConfigurationOverride Override of the backends configuration
     */
    public static function setOverrideOptions( $defaultBackendOverride, $backendsOverride = null, $backendsConfigurationOverride = null )
    {
        self::$defaultBackendOverride = $defaultBackendOverride;
        self::$backendsOverride = $backendsOverride;
        self::$backendsConfigurationOverride = $backendsConfigurationOverride;
    }

    /**
     * Creates a BinaryFile object from the uploaded file $uploadedFile
     * @param array $uploadedFile The _POST hash of an uploaded file
     * @param string $repositoryPath The path the file must be stored as
     * @return \ezp\Io\BinaryFile
     * @throws InvalidArgumentValue When given an invalid uploaded file
     */
    public function createFromUploadedFile( array $uploadedFile, $repositoryPath )
    {
        if ( !isset( $uploadedFile['tmp_name'] ) || !is_uploaded_file( $uploadedFile['tmp_name'] ) )
        {
            throw new InvalidArgumentValue( 'uploadedFile', $uploadedFile );
        }

        $file = new BinaryFile();
        $file-&gt;size = $uploadedFile['size'];
        $file-&gt;ctime = new DateTime;
        $file-&gt;mtime = clone $file-&gt;ctime;
        $file-&gt;contentType = $uploadedFile['type'];

        return $file;
    }

    /**
     * Creates a BinaryFile object from $localFile
     * @param string $localFile
     * @param string $repositoryPath The path the file must be stored as. If false, $localFile will be used.
     * @return \ezp\Io\BinaryFile
     * @throws InvalidArgumentValue When given a non existing / unreadable file
     */
    public function createFromLocalFile( $localFile, $repositoryPath = false )
    {
        if ( !file_exists( $localFile ) || !is_readable( $localFile ) )
        {
            throw new InvalidArgumentValue( 'localFile', $localFile );
        }

        $repositoryPath = $repositoryPath ?: $localFile;
        $file = new BinaryFileCreateStruct();
        $file-&gt;originalFile = basename( $localFile );
        $file-&gt;size = filesize( $localFile );
        $file-&gt;contentType = ContentType::getFromPath( $localFile );
        $file-&gt;path = $repositoryPath;

        $inputStream = fopen( $localFile, 'rb' );
        $file-&gt;setInputStream( $inputStream );

        return $this-&gt;create( $file );
    }

    /**
     * Stores $binaryFile to the repository
     * @param BinaryFileCreateStruct $binaryFile
     * @return BinaryFile The created BinaryFile object
     */
    public function create( BinaryFileCreateStruct $binaryFile )
    {
        return $this-&gt;getBackend( $binaryFile-&gt;path )-&gt;create( $binaryFile );
    }

    /**
     * Updates the file identified by $path with data from $updateFile
     *
     * @param string $path
     * @param BinaryFileUpdateStruct $updateFile
     * @return BinaryFile The update BinaryFile
     */
    public function update( $path, BinaryFileUpdateStruct $updateFile )
    {
        return $this-&gt;getBackend( $path )-&gt;update( $path, $updateFile );
    }

    /**
     * Checks if a BinaryFile with $path exists in the repository
     *
     * @param mixed $binaryFile
     * @return bool
     */
    public function exists( $path )
    {
        return $this-&gt;getBackend( $path )-&gt;exists( $path );
    }

    /**
     * Deletes the BinaryFile with $path
     *
     * @param string $path
     * @throws Exception if no such file exists
     */
    public function delete( $path )
    {
        $this-&gt;getBackend( $path )-&gt;delete( $path );
    }

    /**
     * Loads the binary file with $path
     *
     * @param string $path
     * @return \ezp\Io\BinaryFile
     */
    public function load( $path )
    {
        return $this-&gt;getBackend( $path )-&gt;load( $path );
    }

    /**
      * Returns a read (mode: rb) file resource to the binary file identified by $path
      * @param string $path
      * @return resource
      */
    public function getFileResource( $path )
    {
        return $this-&gt;getBackend( $path )-&gt;getFileResource( $path );
    }

    /**
     * Returns the contents of the BinaryFile identified by $path
     * @param string $path
     * @return string Binary content
     */
    public function getFileContents( $path )
    {
        return $this-&gt;getBackend( $path )-&gt;getFileContents( $path );
    }

    /**
     * Returns the appropriate backend for $path
     * @param string $path
     * @return \ezp\Io\Handler
     */
    private function getBackend( $path )
    {
        // @todo Load appropriate backend based on Match criteria
        return $this-&gt;backends[$this-&gt;defaultBackend];
    }

    /**
     * Initializes the backend identified  by $identifier
     * @var string $identifier
     * @throws BadConfiguration on non existing backend identifier
     * @throws BadConfiguration on non existing backend class
     */
    private function initBackend( $identifier, $backendsConfigurationOverride = null )
    {
        if ( !array_key_exists( $identifier, $this-&gt;backends ) )
        {
            throw new BadConfiguration( &quot;io/general/DefaultBinaryFileBackend&quot; );
        }

        $configurationKey = &quot;backend_settings_{$identifier}&quot;;
        if ( isset( $backendsConfigurationOverride[$configurationKey] ) )
        {
            $backendClass = $backendsConfigurationOverride[$configurationKey][&quot;Class&quot;];
        }
        else
        {
            $backendClass = $this-&gt;configuration-&gt;get( &quot;backend_settings_{$identifier}&quot;, &quot;Class&quot; );
        }
        if ( !class_exists( $backendClass ) )
        {
            throw new BadConfiguration(
                &quot;io/backend_settings_{$identifier}/Class&quot;,
                &quot;The configured backend class couldn't be found&quot;
            );
        }
        $this-&gt;backends[$identifier] = new $backendClass;
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>