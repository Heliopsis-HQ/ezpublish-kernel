<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * File containing the image Manager class
 *
 * @copyright Copyright (C) 1999-2012 eZ Systems AS. All rights reserved.
 * @license http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
 * @version //autogentag//
 */

namespace ezp\Content\FieldType\Image;
use ezp\Base\Legacy\Carpet,
    ezp\Base\Image\Data as ImageData,
    ezp\Base\BinaryRepository,
    ezp\Content\FieldType\Image\AliasCollection,
    ezp\Io\FileInfo,
    DateTime;

/**
 * Wraps eZImageManager class from old eZ Publish
 *
 * @note This implementation is to be changed not to be dependent on the old eZImageManager
 */
class Manager extends Carpet
{
    protected static $className = 'eZImageManager';

    /**
     * Image alias collection object for which this manager is used
     *
     * @var \ezp\Content\FieldType\Image\AliasCollection
     */
    protected $aliasCollection;

    /**
     * The binary repository.
     * Can be used to store image aliases once generation is done
     *
     * @var \ezp\Base\BinaryRepository
     */
    protected $binaryRepository;

    /**
     * Legacy image manager class
     *
     * @var \eZImageManager
     */
    protected $object;

    /**
     * Constructor
     *
     * @param \ezp\Content\FieldType\Image\AliasCollection $aliasCollection The image alias collection calling this manager
     * @param \ezp\Base\BinaryRepository The binary repository
     */
    public function __construct( AliasCollection $aliasCollection, BinaryRepository $binaryRepository )
    {
        parent::__construct( static::$className );
        $this-&gt;aliasCollection = $aliasCollection;
        // Build the legacy eZImageManager object through eZImageManager::factory()
        $this-&gt;object = forward_static_call( array( static::$className, 'factory' ) );
    }

    /**
     * Creates the image alias $aliasName if it's not already part of the
     * existing aliases
     *
     * @param string $aliasName Name of the alias to create
     * @param array $parameters Optional array that can be used to specify the original image's basename
     * @return \ezp\Content\FieldType\Image\Alias
     */
    public function createImageAlias( $aliasName )
    {
        $alias = new Alias;

        return $alias;
    }

    /**
     * Creates original alias from $imageInfo.
     * $originalFilename will be stored in the alias object
     *
     * @param \ezp\Io\FileInfo $imageInfo Object containing all information regarding physical image file
     * @param string $originalFilename The original file name to store in the alias ($imageInfo filename is a temporary unique hash)
     * @return \ezp\Content\FieldType\Image\Alias
     */
    public function createOriginalAlias( FileInfo $imageInfo, $originalFilename )
    {
        // Store in the repository as operations will be done in the repository for concurrency protection.
        // @see eZImageManager::createImageAlias(), starting from line 864
        $imageFile = $this-&gt;binaryRepository-&gt;createFromLocalFile( $imageInfo-&gt;getPathname() );

        $aliasListForLegacy = array(
            'original' =&gt; array(
                'name' =&gt; (string)$imageInfo,
                'url' =&gt; $imageInfo-&gt;getPathname(),
                'filename' =&gt; $imageInfo-&gt;getFilename(),
                'dirpath' =&gt; $imageInfo-&gt;getPath(),
                'basename' =&gt; $imageInfo-&gt;getBasename( $imageInfo-&gt;getExtension() ),
                'suffix' =&gt; $imageInfo-&gt;getExtension(),
                'prefix' =&gt; false,
                'is_valid' =&gt; true,
                'alternative_text' =&gt; '',
                'original_file_name' =&gt; $originalFilename
            )
        );

        // $aliasListForLegacy is passed by reference and will be filled by legacy image manager
        $this-&gt;object-&gt;createImageAlias(
            'original',
            $aliasListForLegacy,
            array( 'basename' =&gt; $aliasListForLegacy['original']['basename'] )
        );

        // Refetch the image file from the binary repository
        // Modification could have been made in underlying image manager
        $imageFile = $this-&gt;binaryRepository-&gt;load( $imageInfo-&gt;getPathname() );

        // Image analysis, for advanced information like EXIF and GIF info
        // Result will be contained in $aliasListForLegacy['original']['info']
        $this-&gt;object-&gt;analyzeImage( $aliasListForLegacy['original'] );

        $width = isset( $aliasListForLegacy['original']['width'] ) ? $aliasListForLegacy['original']['width'] : false;
        $height = isset( $aliasListForLegacy['original']['height'] ) ? $aliasListForLegacy['original']['height'] : false;
        $alias = new Alias(
            array(
                'name' =&gt; 'original',
                'width' =&gt; $width,
                'height' =&gt; $height,
                'fileInfo' =&gt; new FileInfo( $aliasListForLegacy['original']['url'] ),
                'originalFilename' =&gt; $originalFilename,
                'aliasKey' =&gt; $aliasListForLegacy['original']['alias_key'],
                'modified' =&gt; new DateTime,
                'isValid' =&gt; true,
                'isNew' =&gt; true,
            )
        );
        if ( isset( $aliasListForLegacy['original']['info'] ) &amp;&amp; $aliasListForLegacy['original']['info'] !== false )
            $alias-&gt;info = $this-&gt;buildImageData( $aliasListForLegacy['original']['info'] );

        return $alias;
    }

    /**
     * Builds an {@link \ezp\Base\Image\Data} object from $imageInfo and maps properties
     *
     * @param array $imageInfo Image info array returned by legacy image analyzer
     * @see \eZImageManager::analyzeImage()
     * @return \ezp\Base\Image\Data
     */
    private function buildImageData( array $imageInfo )
    {
        $imageData = new ImageData;
        foreach ( $imageInfo as $imageProp =&gt; $value )
        {
            switch ( $imageProp )
            {
                case 'exif':
                case 'ifd0':
                    $imageData-&gt;exif[$imageProp] = $value;
                    break;

                case 'Width':
                case 'width':
                    $imageData-&gt;width = (int)$value;
                    break;

                case 'Height':
                case 'height':
                    $imageData-&gt;height = (int)$value;
                    break;

                case 'IsColor':
                    $imageData-&gt;isColor = (bool)$value;
                    break;

                default:
                    // Check if camelized property is available
                    $camelizedProp = str_replace( '_', ' ', $imageProp );
                    $camelizedProp = ucwords( $camelizedProp );
                    $camelizedProp = lcfirst( str_replace( ' ', '', $camelizedProp ) );
                    if ( property_exists( $imageData, $camelizedProp ) )
                        $imageData-&gt;$camelizedProp = $value;
                    else
                        $imageData-&gt;advancedData[$imageData] = $value;
            }
        }

        return $imageData;
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>